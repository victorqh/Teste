@{
    ViewData["Title"] = "Chat Asistente Virtual";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="bi bi-robot"></i> Asistente Virtual Tienda UPN
                    </h4>
                    <small>Preg√∫ntame sobre productos, precios y ofertas</small>
                </div>
                
                <div class="card-body p-0">
                    <!-- Chat Messages Container -->
                    <div id="chatMessages" class="p-3" style="height: 500px; overflow-y: auto; background-color: #f8f9fa;">
                        <!-- Welcome Message -->
                        <div class="message bot-message mb-3">
                            <div class="d-flex align-items-start">
                                <div class="avatar bg-primary text-white rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; min-width: 40px;">
                                    <i class="bi bi-robot"></i>
                                </div>
                                <div class="message-content bg-white p-3 rounded shadow-sm" style="max-width: 80%;">
                                    <p class="mb-0">
                                        ¬°Hola! üëã Soy tu asistente virtual de Tienda UPN.<br><br>
                                        ¬øEn qu√© puedo ayudarte hoy?<br><br>
                                        Puedo ayudarte con:
                                    </p>
                                    <ul class="mb-0 mt-2">
                                        <li>üîç Buscar productos</li>
                                        <li>üí∞ Ver ofertas y precios</li>
                                        <li>üì± Recomendar productos</li>
                                        <li>‚ùì Responder preguntas</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer bg-white">
                    <!-- Input Area -->
                    <form id="chatForm" class="d-flex gap-2">
                        <input 
                            type="text" 
                            id="messageInput" 
                            class="form-control" 
                            placeholder="Escribe tu mensaje aqu√≠..."
                            autocomplete="off"
                            required>
                        <button type="submit" class="btn btn-primary" id="sendButton">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </form>
                    <small class="text-muted d-block mt-2">
                        <i class="bi bi-info-circle"></i> Powered by Google Gemini AI
                    </small>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="mt-3">
                <p class="text-muted mb-2"><small>Prueba estas preguntas:</small></p>
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-sm btn-outline-secondary quick-question">Mu√©strame laptops</button>
                    <button class="btn btn-sm btn-outline-secondary quick-question">¬øQu√© ofertas hay?</button>
                    <button class="btn btn-sm btn-outline-secondary quick-question">Celulares baratos</button>
                    <button class="btn btn-sm btn-outline-secondary quick-question">Laptops para gaming</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let sessionId = localStorage.getItem('chatSessionId') || '';
        
        const chatMessages = document.getElementById('chatMessages');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        // Auto-scroll to bottom
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Add user message to UI
        function addUserMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message mb-3';
            messageDiv.innerHTML = `
                <div class="d-flex align-items-start justify-content-end">
                    <div class="message-content bg-primary text-white p-3 rounded shadow-sm" style="max-width: 80%;">
                        <p class="mb-0">${escapeHtml(message)}</p>
                    </div>
                    <div class="avatar bg-secondary text-white rounded-circle ms-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; min-width: 40px;">
                        <i class="bi bi-person-fill"></i>
                    </div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // Add bot message to UI
        function addBotMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot-message mb-3';
            
            // Convert markdown-like formatting to HTML
            let formattedMessage = message
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
            
            messageDiv.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="avatar bg-primary text-white rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; min-width: 40px;">
                        <i class="bi bi-robot"></i>
                    </div>
                    <div class="message-content bg-white p-3 rounded shadow-sm" style="max-width: 80%;">
                        <p class="mb-0">${formattedMessage}</p>
                    </div>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // Add typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'message bot-message mb-3';
            typingDiv.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="avatar bg-primary text-white rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; min-width: 40px;">
                        <i class="bi bi-robot"></i>
                    </div>
                    <div class="message-content bg-white p-3 rounded shadow-sm">
                        <div class="typing-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const typingDiv = document.getElementById('typingIndicator');
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        // Send message to server
        async function sendMessage(message) {
            if (!message.trim()) return;

            // Disable input
            messageInput.disabled = true;
            sendButton.disabled = true;

            // Add user message to UI
            addUserMessage(message);
            messageInput.value = '';

            // Show typing indicator
            showTypingIndicator();

            try {
                const response = await fetch('/Chat/SendMessage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        sessionId: sessionId
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Save session ID
                    if (data.sessionId) {
                        sessionId = data.sessionId;
                        localStorage.setItem('chatSessionId', sessionId);
                    }

                    // Add bot response
                    hideTypingIndicator();
                    addBotMessage(data.response);
                } else {
                    hideTypingIndicator();
                    addBotMessage('‚ùå ' + (data.error || 'Error al procesar el mensaje'));
                }
            } catch (error) {
                hideTypingIndicator();
                addBotMessage('‚ùå Error de conexi√≥n. Por favor, intenta de nuevo.');
                console.error('Error:', error);
            } finally {
                // Re-enable input
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
            }
        }

        // Handle form submission
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message) {
                sendMessage(message);
            }
        });

        // Handle quick questions
        document.querySelectorAll('.quick-question').forEach(button => {
            button.addEventListener('click', () => {
                const question = button.textContent;
                sendMessage(question);
            });
        });

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Focus input on load
        messageInput.focus();
    </script>

    <style>
        /* Typing indicator animation */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #6c757d;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @@keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        /* Smooth scrolling */
        #chatMessages {
            scroll-behavior: smooth;
        }

        /* Message animations */
        .message {
            animation: fadeIn 0.3s ease-in;
        }

        @@keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
}
